<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7QEDKLDK8M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'G-7QEDKLDK8M');

    </script>
    <!--  Finish Global site tag (gtag.js) - Google Analytics -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Discover output devices for microcontroller projects in Fab Academy 2020 with Lucio Pentagna. Explore examples of actuators, motors, servos, and displays. Learn about power consumption measurement, board design, programming, and interfacing output devices with ATtiny44 microcontrollers."/>
    <meta name="author" content="Lucio Pentagna">
    <link rel="icon" href="media/favicon.ico">
    <title>Output Devices - Fab Academy 2020 - Lucio Pentagna</title>
    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="media/fabacademy.css" rel="stylesheet">
    <!-- 3D files viewer -->
    <script type="text/javascript" src="media/jsc3d_ie.min.js" defer></script>
    <script type="text/javascript" src="media/jsc3d.min.js" defer></script>
    <script type="text/javascript" src="media/jsc3d.webgl.js" defer></script>
    <script type="text/javascript" src="media/jsc3d.touch.js" defer></script>
    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="bootstrap/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bootstrap/js/ie-emulation-modes-warning.js" defer></script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>    <![endif]-->
    <!-- Load the menu file -->
    <script>
        function menu() {
            $('#exercises').load("exercises-menu.html");
            $('#project').load("project-menu.html");
            $('#cclicense').load("license.html");
        }

    </script>
</head>

<body onload="menu()">
    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="index.html">Lucio Pentagna</a> </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="about.html">About</a></li>
                    <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Exercises <span class="caret"></span></a>
                        <ul id="exercises" class="dropdown-menu" role="menu"> </ul>
                    </li>
                    <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Final Project <span class="caret"></span></a>
                        <ul id="project" class="dropdown-menu" role="menu"> </ul>
                    </li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <div class="container">
        <!-- Insert your content here below! -->
        <div class="jumbotron" style="width: 100%">
            <h3>Output Devices</h3>
            <hr>
            <h4>Group assignment</h4>
            <ul>
                <li>Measure the power consumption of an output device</li>
                <li>Document your work (in a group or individually)</li>
            </ul>
            <h4>Individual assignment</h4>
            <ul>
                <li>Add an output device to a microcontroller board you've designed and program it to do something</li>
            </ul>
            <h4>Learning outcomes:</h4>
            <ul>
                <li>Demonstrate workflows used in controlling an output device(s) with MCU board you have designed</li>
            </ul>
            <h4>Have you:</h4>
            <ul>
                <li>Linked to the group assignment page</li>
                <li>Documented how you determined power consumption of an output device with your group</li>
                <li>Documented what you learned from interfacing output device(s) to microcontroller and controlling the device(s)</li>
                <li>Described your design and fabrication process or linked to previous examples.</li>
                <li>Explained the programming process/es you used</li>
                <li>Outlined problems and how you fixed them</li>
                <li>Included original design files and code</li>
                <li>Included a 'hero shot/video' of your board</li>
            </ul>
        </div>
        <hr>
        <h3>Tools used</h3>
        <ul style="list-style-type:disc">
            <li>Soldering station</li>
            <li>Small CNC</li>
        </ul>
        <hr>
        <h3>Software Used</h3>
        <ul style="list-style-type:disc">
            <li>Autodesk Eagle</li>
            <li>Arduino IDE</li>
        </ul>
        <hr>
        <h4>Files</h4>
        <ol>
            <li>Eagle <a href="https://gitlab.fabcloud.org/academany/fabacademy/2020/labs/algarve/students/lucio/-/tree/master/media/output_devices/eagle">files</a></li>
            <li>G-code <a href="https://gitlab.fabcloud.org/academany/fabacademy/2020/labs/algarve/students/lucio/-/tree/master/media/output_devices/gcode">files</a></li>
            <li>Code <a href="https://gitlab.fabcloud.org/academany/fabacademy/2020/labs/algarve/students/lucio/-/tree/master/media/output_devices/code">files</a></li>
            <li>Datasheet <a href="media/input_devices/datasheet/">files</a></li>
        </ol>
        <hr>

        <h3> Group Assignment
        </h3>
        <p>Go to <a href="http://fabacademy.org/2020/labs/algarve/">group assignment page</a></p>
        <hr>
        <h4>Introduction</h4>
        <p> I started this assignment with the intention to improve the farm irrigation automation. We already have an ESP8266 controlling a pump and 4 relays and monitoring the pump's current draw. The problem is that the ESP8266 on its program is not responsive and makes setting up the times time consuming. This is due to a limitation on the quantity of ADC pins. It was explained to me by the Shakeel one volunteer that we had in the farm that the ESP8266 uses the only ADC pin to monitor its wifi connection so he created a program that reduces the samples taken by the amp meter in other to share the pin with the wifi. Well this works but makes the wifi connection unreliable, so my challenge will be trying to understand the ESP32 so I can port his program and complete the assignment at the same time. Lets try!</p>
        <p>The other thing I would like to point is that I will focus more on the code as I already demonstrated the PCB manufacturing process In the other week and also as a major change in the way I complete the assignment is that I will document as I learn and do things so the assignment will feel more like a log than a tutorial.</p>
        <hr>
        <h4>Objectives</h4>
        <p>My initial objective will be to understand more the ESP32 and then as a second objective have it replacing the current irrigation control a third objective will be applying all this knowledge to my incubator final project.</p>
        <hr>
        <h4>Pinout</h4>
        <p class="pic"><img src="media/output_devices/ESP32-Pinout.jpg" alt="ESP32 Pinout"></p>
        <hr>
        <h4>Code plan</h4>
        <ol>
            <li>check time</li>
            <li>turn on pump if in time range</li>
            <li>read amp meter looking for under and over current if detected it will stop pump operation</li>
        </ol>
        <hr>
        <h4>Code research</h4>
        <p>I started by checking the website <a href="https://techtutorialsx.com/2018/02/17/esp32-arduino-controlling-a-relay/">techtutorialsx.com</a></p>
        <p>As it is explained by the page the code to turn on a relay is pretty similar to other arduino codes I have seen so let's see</p>
        <p> I will be using <code>int pumprelayPin1 = 20;</code> to define the variable pumprelayPin1 as the pin 20 and will store the value as an <a href="https://www.arduino.cc/reference/en/language/variables/data-types/int/">integer</a>.</p>
        <p><code>pinMode(pumprelayPin1, OUTPUT);</code> sets the pin mode for pumprelayPin1 as an output pin meaning it will be active as opposed to input that passively monitors for a signal.</p>
        <p><code>digitalWrite(pumprelayPin1, LOW);</code> will set the pin to an off state with the <code>LOW </code></p>
        <p><code> delay(4000);</code> will tell the program to wait 4 seconds or 4000 milliseconds</p>
        <p> Thats how my code looks so far:</p>
        <pre class="prettyprint linenums">int pumprelayPin1 = 20;

void setup() {
  
  pinMode(pumprelayPin1, OUTPUT);
  digitalWrite(pumprelayPin1, LOW);

}

void loop() {

  digitalWrite(pumprelayPin1, HIGH);
  delay(4000);
  digitalWrite(pumprelayPin1, LOW);
  delay(4000);

}
</pre>
        <p> This code so far will start and then turn on and off the relay with 4 seconds between each operation.</p>
        <p>Now for the second part I want to get time from a real time clock in oder to activate the pump on certain times. So first I need to include the RTC clock library. I am using a DS1302 RTC clock chip so this library should do the trick with this code <code>#include &#60virtuabotixRTC.h&#62</code> according to library documentation <a href="https://github.com/chrisfryer78/ArduinoRTClibrary/blob/master/examples/virtuabotixRTC_version1/virtuabotixRTC_version1.ino">here.</a></p>
        <p>Second we need to declare the pins of the rtc clock with this code <code>virtuabotixRTC myRTC(5, 18, 19);</code> and <code>RtcDS1302&#60ThreeWire&#62 Rtc(myWire);</code> this means when the ESP32 communicates with the real time clock chip it will be using the pins 5 to CLK 18 to DAT and 19 to RST.</p>
        <p>Now in other to show the time from the real time clock I include this either in the <code>void setup() {}</code> area or in the <code>void loop() {}</code> area. The first will print it once the second will print it until I have it running. Of course we need to add a delay of at least of a minute with <code>delay(60000);</code> the unit in the variable is milliseconds so 1000 means 1 second and 60000 means 60 seconds.</p>
        <pre class="prettyprint linenums">    Serial.begin(115200);

 myRTC.updateTime();
    Serial.println();</pre>
        <p>If the RTC was never used before you can set the time running once the following code: <code> myRTC.setDS1302Time(00, 28, 16, 6, 23, 5, 2020);</code> being the first characters seconds then minutes, hours (24h mode), day of the week, day of the month, month, year)</p>
        <p>This is how the code is looking so far:</p>
        <pre class="prettyprint linenums">#include &#60virtuabotixRTC.h&#62

virtuabotixRTC myRTC(5, 18, 19);// (CLK,DAT,RST)

int pumprelayPin1 = 22;

void setup() {

    Serial.begin(115200);
    pinMode(pumprelayPin1, OUTPUT);
}
void loop() {

    myRTC.updateTime();
  
    Serial.print(myRTC.hours);
    Serial.print(":");
    Serial.print(myRTC.minutes);
    delay(58000);
  
    digitalWrite(pumprelayPin1, HIGH);
    delay(1000);
    digitalWrite(pumprelayPin1, LOW);
    delay(1000);

}</pre>
        <p>So far there is no logic test the code shows the time every minute and turns on and off the relay. So in other to add a logic test we need the <code>if</code> statement. It will check if something is true and then execute whatever next in the program.</p>
        <p>Extracted from the <a href="https://www.arduino.cc/reference/en/language/structure/control-structure/if/">Arduino references</a>: </p>
        <pre><code><code>if (condition) {
    //statement(s)
}</code></code></pre>
        <p>So In other to check the time and turn on my relay I will try something like this: <code>if ((myRTC.hours) == 15 || (myRTC.minutes) == 0) {digitalWrite(pumprelayPin1, HIGH)}</code></p>
        <p>To turn of the code will be like this: <code>if ((myRTC.hours) >= 15 || (myRTC.minutes) >= 1) {digitalWrite(pumprelayPin1, LOW)}</code></p>
        <p>My code now looks like this:</p>
        <pre class="prettyprint linenums">//libraries
#include &#60virtuabotixRTC.h&#62

//Settings
virtuabotixRTC myRTC(5, 18, 19);// (CLK,DAT,RST)
int pumprelayPin1 = 22;


//run once
void setup() {

   Serial.begin(115200);
   
myRTC.setDS1302Time(50, 15, 16, 6, 24, 5, 2020); // sets seconds, minutes, hours (24h mode), day of the week, day, month, year) comment after first compile
  
  pinMode(pumprelayPin1, OUTPUT);
  
}

//run in loop
void loop() {
  myRTC.updateTime();//updates time
  Serial.print("Current Time: ");
  Serial.print(myRTC.hours);
  Serial.print(":");
  Serial.print(myRTC.minutes);
  Serial.print(":");
  Serial.print(myRTC.seconds);
  Serial.println();
  delay (1000);
//condition (logic test)
if ((myRTC.minutes) == 16) digitalWrite(pumprelayPin1, HIGH);  
if ((myRTC.minutes) >= 17) digitalWrite(pumprelayPin1, LOW);

}
</pre>
        <p>here is how it runs on the ESP32 development board</p>
        <p class="pic"><video controls alt="Program experiment video">
                <source src="media/output_devices/programexperiment.mp4">Your browser does not support HTML5 video.
            </video>
            <legend>You can see a higher resolution on <a href="https://www.youtube.com/watch?v=cW_LQhQiVxQ">Youtube</a></legend>
        </p>
        <hr>
        <h4>Board design</h4>
        <p>For this board I will need at least 4 digital pins and one analog pin if I want to measure the current of the pump in the future. So I believe the ATtiny44 will be suitable enough. I will leave the ESP32 for the Network week ;-). Also my esp32 smd component haven't arrived yet, I believe it is because of COVID19 break of supply chains. Thats why I experimented with the ESP32 development board I had in hand. </p>
        <h5>Pinout of ATtiny44</h5>
        <p class="pic"><img src="media/output_devices/attiny44pinout.jpg" alt="ATtiny44 Pinout"></p>
        <p>With that in hand I will modify the tiny45 I did in the input devices week by adding another header for a more comfortable programing and serial monitoring as well as all the pins to have this board as modular as possible.</p>
        <p>I wont be covering the eagle design or milling in detail as I already did in the <a href="input_devices.html">Input devices week</a>. Instead I will only cover the comands I might not have used like replace and then a few hero shots and tests.</p>
        <p>So lets start with the redesign!</p>
        <ol>
            <li>I start by opening the old eagle file <a href="media/input_devices/eagle/eaglefilestinyboard.zip">here.</a></li>
            <li>I tried the command replace but it did not work to replace the Attiny45 for the attiny44 they are too different I guess. So I will have to add the new component remap the connections with net than name and then reroute everything on the board. Lets see.</li>
        </ol>
        <p>This is the Board Schematics and Layout</p>
        <p class="pic"><img src="media/output_devices/tiny44schematics.jpg" alt="Tiny44 Schematics">
            <legend>Schematics</legend>
        </p>
        <p class="pic"><img src="media/output_devices/tiny44board.jpg" alt="Tiny44 Board Layout">Board Layout</p>
        <p>Next I run the ULP pcb-gcode just like explained on <a href="input_devices.html">Output Devices</a></p>
        <p class="pic"><img src="media/output_devices/pcbtogcode.jpg" alt="G-code isolation visualization">G-code isolation visualization</p>
        <p>Next I use the program Autoleveller also explained on <a href="input_devices.html">Output Devices</a> and I obtain a G-code that is adjusted to the imperfections of the blank pcb.</p>
        <p class="pic"><img src="media/output_devices/tiny44autoleveller.jpg" alt="Autoleveller output">Board Layout</p>
        <p>Milling the PCB</p>
        <p class="pic"><video controls alt="Milling PCB video">
                <source src="media/output_devices/attiny44finalmillingcomp.mp4">Your browser does not support HTML5 video.
            </video></p>
        <p>The milled pcb</p>
        <p class="pic"><img src="media/output_devices/attiny44milled.jpg" alt="Milled PCB">blank pcb</p>
        <p>The Attiny44 board with the soldered components looks like this.</p>
        <p class="pic"><img src="media/output_devices/attiny44populated.jpg" alt="Populated ATtiny44 Board">Board Layout</p>
        <p>Now that I have the pcb done I changed the code to run on the attiny44. One remarcable thing is that the attiny44 needs a software serial library that I invoked with this code <code>#include &#60SoftwareSerial.h&#62</code> two more things for the serial to work: the library needs to know the pins TX and RX are going to be <code>SoftwareSerial Monitor(1, 0);</code> in <code>void setup{}</code> I included the serial monitor initialization with <code>Monitor.begin(115200);</code> intead of the usual <code>Serial.begin(115200);</code> and finally in <code> void loop {}</code> every time I wanted serial to print something I needed to use the code <code>Monitor.print();</code> instead of the usual <code>Serial print ();</code> </p>
        <p>In the end my test code looks like this:</p>
        <pre class="prettyprint linenums">//libraries
#include &#60virtuabotixRTC.h&#62
#include &#60SoftwareSerial.h&#62

//Settings
virtuabotixRTC myRTC(3, 8, 7);// (CLK,DAT,RST)
int pumprelayPin1 = 2;
SoftwareSerial Monitor(1, 0);

//run once
void setup() {

   Monitor.begin(115200);
   
myRTC.setDS1302Time(50, 15, 16, 6, 24, 5, 2020); // sets seconds, minutes, hours (24h mode), day of the week, day, month, year) comment after first compile
  
  pinMode(pumprelayPin1, OUTPUT);
  
}

//run in loop
void loop() {
  myRTC.updateTime();//updates time
  Monitor.print("Current Time: ");
  Monitor.print(myRTC.hours);
  Monitor.print(":");
  Monitor.print(myRTC.minutes);
  Monitor.print(":");
  Monitor.print(myRTC.seconds);
  Monitor.println();
  delay (1000);
//condition (logic test)
if ((myRTC.minutes) == 16) digitalWrite(pumprelayPin1, HIGH);  
if ((myRTC.minutes) >= 17) digitalWrite(pumprelayPin1, LOW);

}</pre>
        <p>Now lets program! For Another method without the Arduino IDE check <a href="embedded_programming.html">Embedded Programing</a></p>
        <p class="pic"><img src="media/output_devices/programmerusbasp.jpg" alt="USBasp programmer">USBasp</p>
        <p>Programming an attiny44 board with arduino using a FabTinyISP or USBtinyISP that I made.</p>
        <p class="pic"><img src="media/output_devices/programmerfabisp.jpg" alt="FabISP programmer">FabISP</p>
        <p>Programming an attiny44 board with arduino using a FabTinyISP or USBtinyISP that I made was fine. there is only the inconvenience of having to power the target board.</p>
        <p>Start by oppening the Arduino IDE, than in tools chose the board, in my case ATtiny24/44/84, Next in processor I chose Attiny44.</p>
        <p class="pic"><img src="media/output_devices/programingATtiny44_with_arduino.jpg" alt="Arduino IDE board selection"></p>
        <p>Next chose the clock, as I m not using a external crystal I chose "Internal 8MHz.</p>
        <p class="pic"><img src="media/output_devices/programingATtiny44_with_arduino01.jpg" alt="Arduino IDE clock selection"></p>
        <p>Next go to Programmer:"USBasp or USBtiny for the Fabisp.</p>
        <p class="pic"><img src="media/output_devices/programingATtiny44_with_arduino02.jpg" alt="Arduino IDE programmer selection"></p>
        <p>In the video bellow I show the the process of programming with the FabISP.</p>
        <p class="pic"><video controls title="Programming with FabISP" alt="Programming with FabISP video">
                <source src="media/output_devices/programming_usbtiny.mp4">Your browser does not support HTML5 video.
            </video>For a full resolution video check <a href="https://youtu.be/CKtFtvp55ME">Youtube</a></p>
        <p>In this video I show the process of programming with the USBasp.</p>
        <p class="pic"><video controls title="Programming with USBasp" alt="Programming with USBasp video">
                <source src="media/output_devices/programming_usbasp.mp4">Your browser does not support HTML5 video.
            </video>For a full resolution video check <a href="https://youtu.be/ZyDkVr3AqaQ">Youtube</a></p>
        <p>I can show the Attiny44 controling a relay to turn on a compressor on a specific time set in the program.</p>
        <p class="pic"><video controls alt="Output devices test video">
                <source src="media/output_devices/outputdevicestest.mp4">Your browser does not support HTML5 video.
            </video>For a full resolution video check <a href="https://www.youtube.com/watch?v=wcq0y42teHU">Youtube</a></p>
        <p>Hero Shot</p>
        <p class="pic"><img src="media/output_devices/heroshot.jpeg" alt="Hero shot of the board">Board Layout</p>
        <hr>
        <h4>Foot notes</h4>
        <p>Check usage of <a href="https://www.arduino.cc/reference/en/language/functions/time/millis/">millis</a> in the future</p> <!-- End of your content -->
    </div> <!-- /container -->
    <!-- footer -->
    <footer id="footer">
        <p id="cclicense"> </p>
        <p class="license"> Theme: <a href="https://github.com/openp2pdesign/FabAcademy_Template">Fab Academy Template</a> by <a href="http://openp2pdesign.org">Massimo Menichinelli</a> <br> Based on <a href="http://getbootstrap.com/">Twitter Bootstrap</a>+<a href="http://jquery.com/">JQuery</a>+<a href="https://code.google.com/p/google-code-prettify/">google-code-prettify</a>+<a href="http://jmblog.github.io/color-themes-for-google-code-prettify/github/">GitHub theme for google-code-prettify</a>+<a href="https://code.google.com/p/jsc3d/">JSC3D</a>+<a href="https://github.com/thegrubbsian/jquery.ganttView">jquery.ganttView</a>.
        </p>
        <p>Now lets see the code running on the new board controlling a relay that will turn on a </p>
    </footer>

    <!-- Do not touch this! -->
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="media/jquery-1.9.1.min.js" defer></script>
    <!-- Syntax Highlighter -->
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js" defer></script> <!-- From https://github.com/jmblog/color-themes-for-google-code-prettify -->
    <link href="media/github.css" type="text/css" rel="stylesheet">
    <script type="text/javascript">
        ! function($) {
            $(function() {
                window.prettyPrint && prettyPrint()
            })
        }(window.jQuery)

    </script>
    <script src="bootstrap/js/bootstrap.min.js" defer></script> <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap/js/ie10-viewport-bug-workaround.js" defer></script>
</body>

</html>
